insertQuery =   WITH reference_document AS ( \
                    SELECT id \
                    FROM assembly.as_pd_product_salesorders \
                    WHERE referencedocumentnumber = '{referencedocumentnumber}' \
                ), \
                inserted_record AS ( \
                    INSERT INTO assembly.as_pd_product_salesorders (updatedon, createdby, referencedocumentnumber) \
                    SELECT NOW(), '{createdby}', '{referencedocumentnumber}' \
                    WHERE NOT EXISTS (SELECT 1 FROM reference_document) \
                    RETURNING id \
                ) \
                SELECT id FROM inserted_record \
                UNION ALL \
                SELECT id FROM reference_document;

productionPlanningSelectQuery = SELECT \
                                TRIM(pso.referencedocumentnumber) AS sales_order_number, \
                                ( \
                                    SELECT JSON_AGG( \
                                        JSON_BUILD_OBJECT( \
                                            'product', TRIM(op.code), \
                                            'revision', TRIM(op.revisionno), \
                                            'linenumber', psod.linenumber, \
                                            'quantity', psod.quantity, \
                                            'dispatchdate', psod.dispatchdate, \
                                            'so_id', psod.so_id, \
                                            'so_details_id', psod.id, \
                                            'product_id', psod.product_id, \
                                            'product_structure', ( \
                                                                    WITH RECURSIVE product_hierarchy AS ( \
                                                                    SELECT DISTINCT ON (TRIM(pps.id)) \
                                                                        TRIM(cp.code) AS child_product, \
                                                                        TRIM(cp.revisionno) AS child_revision_number, \
                                                                        pps.level, \
                                                                        GREATEST( \
                                                                            ( \
                                                                                (COALESCE(psod.quantity,0) * COALESCE(pps.quantity,0)) - COALESCE(psh.sum_quantity,0) \
                                                                            ), \
                                                                            0 \
                                                                        ) AS order_quantity, \
                                                                        COALESCE( \
                                                                            CASE \
                                                                                WHEN cp.producttype != '227da8713f2341dbbf85f5cb4e3beb43' AND cp.id = psod.product_id THEN \
                                                                                    COALESCE(psh.sum_quantity,0) \
                                                                                ELSE \
                                                                                    ( \
                                                                                        SELECT MIN( \
                                                                                            GREATEST( \
                                                                                                CASE \
                                                                                                    WHEN COALESCE(child_sum_quantity,0) = 0 \
                                                                                                        THEN 0 \
                                                                                                    WHEN COALESCE(child_sum_quantity,0) > NULLIF(COALESCE(cps.quantity,0),0) \
                                                                                                        THEN COALESCE(child_sum_quantity,0) / NULLIF(COALESCE(cps.quantity,0),0) \
                                                                                                    ELSE NULLIF(COALESCE(cps.quantity,0),0) / COALESCE(child_sum_quantity,0) \
                                                                                                END, \
                                                                                                0 \
                                                                                            ) \
                                                                                        ) \
                                                                                        FROM assembly.as_pd_product_structure cps \
                                                                                        LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                                                                        LEFT JOIN ( \
                                                                                            SELECT productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS child_sum_quantity \
                                                                                            FROM assembly.as_pd_product_stockhistory \
                                                                                            WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                                                                                            GROUP BY productstock_id, parentproduct_id, sodetails_id \
                                                                                        ) cpsh ON cpsh.productstock_id = ps.id AND cpsh.parentproduct_id = psod.product_id \
                                                                                        AND cpsh.sodetails_id =  psod.id \
                                                                                        WHERE cps.parentproduct_id = pps.id \
                                                                                    ) \
                                                                            END, \
                                                                            0 \
                                                                        ) AS pending_schedule_quantity, \
                                                                        COALESCE( \
                                                                            ( \
                                                                                SELECT SUM(scheduledquantity) \
                                                                                FROM assembly.as_production_schedule \
                                                                                WHERE childproduct_id = cp.id AND parentproduct_id = psod.product_id AND so_details_id = psod.id \
                                                                            ), \
                                                                            0 \
                                                                        ) AS scheduled_quantity, \
                                                                        ( \
                                                                            CASE \
                                                                                WHEN cp.producttype != '227da8713f2341dbbf85f5cb4e3beb43' AND cp.id = psod.product_id THEN \
                                                                                    ( \
                                                                                        SELECT JSON_AGG( \
                                                                                            JSON_BUILD_OBJECT( \
                                                                                                'stock_history_id', cpsh.id, \
                                                                                                'child_quantity', pps.quantity \
                                                                                            ) \
                                                                                        ) \
                                                                                        FROM assembly.as_pd_product_stock ps \
                                                                                        JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                                                                                        AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                                                                                        AND cpsh.productionschedule_id IS NULL \
                                                                                        WHERE ps.product_id = cp.id \
                                                                                    ) \
                                                                                ELSE \
                                                                                    ( \
                                                                                        SELECT JSON_AGG( \
                                                                                            JSON_BUILD_OBJECT( \
                                                                                                'stock_history_id', cpsh.id, \
                                                                                                'child_quantity', cps.quantity \
                                                                                            ) \
                                                                                        ) \
                                                                                        FROM assembly.as_pd_product_structure cps \
                                                                                        JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                                                                        JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                                                                                        AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                                                                                        AND cpsh.productionschedule_id IS NULL \
                                                                                        WHERE cps.parentproduct_id = pps.id \
                                                                                    ) \
                                                                            END \
                                                                        ) AS stock_history_id_list, \
                                                                        COALESCE( \
                                                                            ( \
                                                                                SELECT SUM(scheduledquantity) \
                                                                                FROM assembly.as_production_schedule aspsch \
                                                                                WHERE aspsch.childproduct_id = pps.childproduct_id AND parentproduct_id = psod.product_id \
                                                                                AND so_details_id = psod.id \
                                                                            ), \
                                                                            0 \
                                                                        ), \
                                                                        TRIM(pp.code) AS parent_product, \
                                                                        TRIM(pp.revisionno) AS parent_revision_number, \
                                                                        TRIM(pps.id) AS stru_table_id, \
                                                                        TRIM(cp.id) AS child_product_id, \
                                                                        TRIM(ppps.childproduct_id) AS parentproduct_id \
                                                                    FROM assembly.as_pd_product_structure pps \
                                                                    LEFT JOIN assembly.as_pd_product cp ON cp.id = pps.childproduct_id \
                                                                    LEFT JOIN assembly.as_pd_product_structure ppps ON ppps.id = pps.parentproduct_id \
                                                                    LEFT JOIN assembly.as_pd_product pp ON pp.id = ppps.childproduct_id \
                                                                    LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = pps.childproduct_id \
                                                                    LEFT JOIN ( \
                                                                        SELECT id AS parentStockhistory_id, productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS sum_quantity \
                                                                        FROM assembly.as_pd_product_stockhistory \
                                                                        WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                                                                        GROUP BY id, productstock_id, parentproduct_id, sodetails_id \
                                                                    ) psh ON psh.productstock_id = ps.id  AND psh.parentproduct_id =  psod.product_id AND psh.sodetails_id =  psod.id \
                                                                    WHERE pps.childproduct_id = psod.product_id AND pps.revisionno = op.revisionno AND pps.level = 0 \
                                                                    UNION ALL \
                                                                    SELECT DISTINCT ON (TRIM(pps.id)) \
                                                                        TRIM(cp.code) AS child_product, \
                                                                        TRIM(cp.revisionno) AS child_revision_number, \
                                                                        pps.level, \
                                                                        GREATEST( \
                                                                            ( \
                                                                                (COALESCE(pps.quantity, 0) * COALESCE(ph.order_quantity, 0)) - COALESCE(psh.sum_quantity,0) \
                                                                            ), \
                                                                            0 \
                                                                        ) AS order_quantity, \
                                                                        COALESCE( \
                                                                            CASE \
                                                                                WHEN cp.producttype != '227da8713f2341dbbf85f5cb4e3beb43' AND cp.id = psod.product_id THEN \
                                                                                    COALESCE(psh.sum_quantity,0) \
                                                                                ELSE \
                                                                                    ( \
                                                                                        SELECT MIN( \
                                                                                            GREATEST( \
                                                                                                CASE \
                                                                                                    WHEN COALESCE(child_sum_quantity,0) = 0 \
                                                                                                        THEN 0 \
                                                                                                    WHEN COALESCE(child_sum_quantity,0) > NULLIF(COALESCE(cps.quantity,0),0) \
                                                                                                        THEN COALESCE(child_sum_quantity,0) / NULLIF(COALESCE(cps.quantity,0),0) \
                                                                                                    ELSE NULLIF(COALESCE(cps.quantity,0),0) / COALESCE(child_sum_quantity,0) \
                                                                                                END, \
                                                                                                0 \
                                                                                            ) \
                                                                                        ) \
                                                                                        FROM assembly.as_pd_product_structure cps \
                                                                                        LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                                                                        LEFT JOIN ( \
                                                                                            SELECT productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS child_sum_quantity \
                                                                                            FROM assembly.as_pd_product_stockhistory \
                                                                                            WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                                                                                            GROUP BY productstock_id, parentproduct_id, sodetails_id \
                                                                                        ) cpsh ON cpsh.productstock_id = ps.id  AND cpsh.parentproduct_id =  psod.product_id AND cpsh.sodetails_id =  psod.id \
                                                                                        WHERE cps.parentproduct_id = pps.id \
                                                                                    ) \
                                                                            END, \
                                                                            0 \
                                                                        ) AS pending_schedule_quantity, \
                                                                        COALESCE( \
                                                                            ( \
                                                                                SELECT SUM(scheduledquantity) \
                                                                                FROM assembly.as_production_schedule \
                                                                                WHERE childproduct_id = cp.id AND parentproduct_id = psod.product_id AND so_details_id = psod.id \
                                                                            ), \
                                                                            0 \
                                                                        ) AS scheduled_quantity, \
                                                                        ( \
                                                                            CASE \
                                                                                WHEN cp.producttype != '227da8713f2341dbbf85f5cb4e3beb43' AND cp.id = psod.product_id THEN \
                                                                                    ( \
                                                                                            SELECT JSON_AGG( \
                                                                                                JSON_BUILD_OBJECT( \
                                                                                                    'stock_history_id', cpsh.id, \
                                                                                                    'child_quantity', pps.quantity \
                                                                                                ) \
                                                                                            ) \
                                                                                            FROM assembly.as_pd_product_stock ps \
                                                                                            JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                                                                                            AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                                                                                            AND cpsh.productionschedule_id IS NULL \
                                                                                            WHERE ps.product_id = cp.id \
                                                                                    ) \
                                                                                ELSE \
                                                                                    ( \
                                                                                        SELECT JSON_AGG( \
                                                                                            JSON_BUILD_OBJECT( \
                                                                                                'stock_history_id', cpsh.id, \
                                                                                                'child_quantity', cps.quantity \
                                                                                            ) \
                                                                                        ) \
                                                                                        FROM assembly.as_pd_product_structure cps \
                                                                                        JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                                                                        JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                                                                                        AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                                                                                        AND cpsh.productionschedule_id IS NULL WHERE cps.parentproduct_id = pps.id \
                                                                                    ) \
                                                                            END \
                                                                        ) AS stock_history_id_list, \
                                                                        COALESCE( \
                                                                            ( \
                                                                                SELECT SUM(scheduledquantity) \
                                                                                FROM assembly.as_production_schedule aspsch \
                                                                                WHERE aspsch.childproduct_id = pps.childproduct_id AND parentproduct_id = psod.product_id \
                                                                                AND so_details_id = psod.id \
                                                                            ), \
                                                                            0 \
                                                                        ), \
                                                                        TRIM(pp.code) AS parent_product, \
                                                                        TRIM(pp.revisionno) AS parent_revision_number, \
                                                                        TRIM(pps.id) AS stru_table_id, \
                                                                        TRIM(cp.id) AS child_product_id, \
                                                                        TRIM(ppps.childproduct_id) AS parentproduct_id \
                                                                    FROM assembly.as_pd_product_structure pps \
                                                                    LEFT JOIN assembly.as_pd_product cp ON cp.id = pps.childproduct_id \
                                                                    LEFT JOIN assembly.as_pd_product_structure ppps ON ppps.id = pps.parentproduct_id \
                                                                    LEFT JOIN assembly.as_pd_product pp ON pp.id = ppps.childproduct_id \
                                                                    LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = pps.childproduct_id \
                                                                    LEFT JOIN ( \
                                                                        SELECT id AS parentStockhistory_id , productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS sum_quantity \
                                                                        FROM assembly.as_pd_product_stockhistory \
                                                                        WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                                                                        GROUP BY id, productstock_id, parentproduct_id, sodetails_id \
                                                                    ) psh ON psh.productstock_id = ps.id  AND psh.parentproduct_id =  psod.product_id AND psh.sodetails_id =  psod.id \
                                                                    INNER JOIN product_hierarchy ph ON pps.parentproduct_id = ph.stru_table_id \
                                                                    WHERE pps.level > ph.level \
                                                                ) \
                                                                SELECT JSON_AGG( \
                                                                    JSON_BUILD_OBJECT( \
                                                                        'child_product', child_product, \
                                                                        'child_revision_number', child_revision_number, \
                                                                        'child_product_id', child_product_id, \
                                                                        'level', level, \
                                                                        'parent_product', parent_product, \
                                                                        'parent_revision_number', parent_revision_number, \
                                                                        'parentproduct_id', parentproduct_id, \
                                                                        'order_quantity', order_quantity, \
                                                                        'pending_schedule_quantity', pending_schedule_quantity, \
                                                                        'scheduled_quantity', scheduled_quantity, \
                                                                        'stock_history_id_list', stock_history_id_list \
                                                                    ) \
                                                                ) \
                                                                FROM product_hierarchy \
                                                            ) \
                                                        ) \
                                                    ) \
                                    FROM assembly.as_pd_product_salesorderdetails psod \
                                    LEFT JOIN assembly.as_pd_product op ON op.id = psod.product_id \
                                    WHERE psod.so_id = pso.id \
                                ) AS sales_order_details, \
                                pso.id AS sales_order_id \
                            FROM assembly.as_pd_product_salesorders pso \
                            ORDER BY pso.updatedon DESC;


                            #     SELECT \
                            #     TRIM(pso.referencedocumentnumber) AS sales_order_number, \
                            #     ( \
                            #         SELECT JSON_AGG( \
                            #             JSON_BUILD_OBJECT( \
                            #                 'product', TRIM(op.code), \
                            #                 'revision', TRIM(op.revisionno), \
                            #                 'linenumber', psod.linenumber, \
                            #                 'quantity', psod.quantity, \
                            #                 'dispatchdate', psod.dispatchdate, \
                            #                 'so_id', psod.so_id, \
                            #                 'so_details_id', psod.id, \
                            #                 'product_id', psod.product_id, \
                            #                 'product_structure', ( \
                            #                                         WITH RECURSIVE product_hierarchy AS ( \
                            #                                         SELECT DISTINCT ON (TRIM(pps.id)) \
                            #                                             TRIM(cp.code) AS child_product, \
                            #                                             TRIM(cp.revisionno) AS child_revision_number, \
                            #                                             pps.level, \
                            #                                             GREATEST( \
                            #                                                 ( \
                            #                                                     (COALESCE(psod.quantity,0) * COALESCE(pps.quantity,0)) - COALESCE(psh.sum_quantity,0) \
                            #                                                 ), \
                            #                                                 0 \
                            #                                             ) AS order_quantity, \
                            #                                             COALESCE( \
                            #                                                 CASE \
                            #                                                     WHEN cp.producttype = '227da8713f2341dbbf85f5cb4e3beb43' THEN \
                            #                                                         ( \
                            #                                                             SELECT MIN( \
                            #                                                                 GREATEST( \
                            #                                                                     CASE \
                            #                                                                         WHEN COALESCE(child_sum_quantity,0) = 0 \
                            #                                                                             THEN 0 \
                            #                                                                         WHEN COALESCE(child_sum_quantity,0) > NULLIF(COALESCE(cps.quantity,0),0) \
                            #                                                                             THEN COALESCE(child_sum_quantity,0) / NULLIF(COALESCE(cps.quantity,0),0) \
                            #                                                                         ELSE NULLIF(COALESCE(cps.quantity,0),0) / COALESCE(child_sum_quantity,0) \
                            #                                                                     END, \
                            #                                                                     0 \
                            #                                                                 ) \
                            #                                                             ) \
                            #                                                             FROM assembly.as_pd_product_structure cps \
                            #                                                             LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                            #                                                             LEFT JOIN ( \
                            #                                                                 SELECT productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS child_sum_quantity \
                            #                                                                 FROM assembly.as_pd_product_stockhistory \
                            #                                                                 WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                            #                                                                 GROUP BY productstock_id, parentproduct_id, sodetails_id \
                            #                                                             ) cpsh ON cpsh.productstock_id = ps.id AND cpsh.parentproduct_id = psod.product_id \
                            #                                                             AND cpsh.sodetails_id =  psod.id \
                            #                                                             WHERE cps.parentproduct_id = pps.id \
                            #                                                         ) \
                            #                                                     ELSE COALESCE(psh.sum_quantity,0) \
                            #                                                 END, \
                            #                                                 0 \
                            #                                             ) AS pending_schedule_quantity, \
                            #                                             COALESCE( \
                            #                                                 ( \
                            #                                                     SELECT SUM(scheduledquantity) \
                            #                                                     FROM assembly.as_production_schedule \
                            #                                                     WHERE childproduct_id = cp.id AND parentproduct_id = psod.product_id AND so_details_id = psod.id \
                            #                                                 ), \
                            #                                                 0 \
                            #                                             ) AS scheduled_quantity, \
                            #                                             ( \
                            #                                                 CASE \
                            #                                                     WHEN cp.producttype = '227da8713f2341dbbf85f5cb4e3beb43' THEN \
                            #                                                         ( \
                            #                                                             SELECT JSON_AGG( \
                            #                                                                 JSON_BUILD_OBJECT( \
                            #                                                                     'stock_history_id', cpsh.id, \
                            #                                                                     'child_quantity', cps.quantity \
                            #                                                                 ) \
                            #                                                             ) \
                            #                                                             FROM assembly.as_pd_product_structure cps \
                            #                                                             JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                            #                                                             JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                            #                                                             AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                            #                                                             AND cpsh.productionschedule_id IS NULL \
                            #                                                             WHERE cps.parentproduct_id = pps.id \
                            #                                                         ) \
                            #                                                     ELSE \
                            #                                                         ( \
                            #                                                             SELECT JSON_AGG( \
                            #                                                                 JSON_BUILD_OBJECT( \
                            #                                                                     'stock_history_id', cpsh.id, \
                            #                                                                     'child_quantity', pps.quantity \
                            #                                                                 ) \
                            #                                                             ) \
                            #                                                             FROM assembly.as_pd_product_stock ps \
                            #                                                             JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                            #                                                             AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                            #                                                             AND cpsh.productionschedule_id IS NULL \
                            #                                                             WHERE ps.product_id = cp.id \
                            #                                                         ) \
                            #                                                 END \
                            #                                             ) AS stock_history_id_list, \
                            #                                             COALESCE( \
                            #                                                 ( \
                            #                                                     SELECT SUM(scheduledquantity) \
                            #                                                     FROM assembly.as_production_schedule aspsch \
                            #                                                     WHERE aspsch.childproduct_id = pps.childproduct_id AND parentproduct_id = psod.product_id \
                            #                                                     AND so_details_id = psod.id \
                            #                                                 ), \
                            #                                                 0 \
                            #                                             ), \
                            #                                             TRIM(pp.code) AS parent_product, \
                            #                                             TRIM(pp.revisionno) AS parent_revision_number, \
                            #                                             TRIM(pps.id) AS stru_table_id, \
                            #                                             TRIM(cp.id) AS child_product_id, \
                            #                                             TRIM(ppps.childproduct_id) AS parentproduct_id \
                            #                                         FROM assembly.as_pd_product_structure pps \
                            #                                         LEFT JOIN assembly.as_pd_product cp ON cp.id = pps.childproduct_id \
                            #                                         LEFT JOIN assembly.as_pd_product_structure ppps ON ppps.id = pps.parentproduct_id \
                            #                                         LEFT JOIN assembly.as_pd_product pp ON pp.id = ppps.childproduct_id \
                            #                                         LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = pps.childproduct_id \
                            #                                         LEFT JOIN ( \
                            #                                             SELECT id AS parentStockhistory_id, productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS sum_quantity \
                            #                                             FROM assembly.as_pd_product_stockhistory \
                            #                                             WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                            #                                             GROUP BY id, productstock_id, parentproduct_id, sodetails_id \
                            #                                         ) psh ON psh.productstock_id = ps.id  AND psh.parentproduct_id =  psod.product_id AND psh.sodetails_id =  psod.id \
                            #                                         WHERE pps.childproduct_id = psod.product_id AND pps.revisionno = op.revisionno AND pps.level = 0 \
                            #                                         UNION ALL \
                            #                                         SELECT DISTINCT ON (TRIM(pps.id)) \
                            #                                             TRIM(cp.code) AS child_product, \
                            #                                             TRIM(cp.revisionno) AS child_revision_number, \
                            #                                             pps.level, \
                            #                                             GREATEST( \
                            #                                                 ( \
                            #                                                     (COALESCE(pps.quantity, 0) * COALESCE(ph.order_quantity, 0)) - COALESCE(psh.sum_quantity,0) \
                            #                                                 ), \
                            #                                                 0 \
                            #                                             ) AS order_quantity, \
                            #                                             COALESCE( \
                            #                                                 CASE \
                            #                                                     WHEN cp.producttype = '227da8713f2341dbbf85f5cb4e3beb43' THEN \
                            #                                                         ( \
                            #                                                             SELECT MIN( \
                            #                                                                 GREATEST( \
                            #                                                                     CASE \
                            #                                                                         WHEN COALESCE(child_sum_quantity,0) = 0 \
                            #                                                                             THEN 0 \
                            #                                                                         WHEN COALESCE(child_sum_quantity,0) > NULLIF(COALESCE(cps.quantity,0),0) \
                            #                                                                             THEN COALESCE(child_sum_quantity,0) / NULLIF(COALESCE(cps.quantity,0),0) \
                            #                                                                         ELSE NULLIF(COALESCE(cps.quantity,0),0) / COALESCE(child_sum_quantity,0) \
                            #                                                                     END, \
                            #                                                                     0 \
                            #                                                                 ) \
                            #                                                             ) \
                            #                                                             FROM assembly.as_pd_product_structure cps \
                            #                                                             LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                            #                                                             LEFT JOIN ( \
                            #                                                                 SELECT productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS child_sum_quantity \
                            #                                                                 FROM assembly.as_pd_product_stockhistory \
                            #                                                                 WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                            #                                                                 GROUP BY productstock_id, parentproduct_id, sodetails_id \
                            #                                                             ) cpsh ON cpsh.productstock_id = ps.id  AND cpsh.parentproduct_id =  psod.product_id AND cpsh.sodetails_id =  psod.id \
                            #                                                             WHERE cps.parentproduct_id = pps.id \
                            #                                                         ) \
                            #                                                     ELSE COALESCE(psh.sum_quantity,0) \
                            #                                                 END, \
                            #                                                 0 \
                            #                                             ) AS pending_schedule_quantity, \
                            #                                             COALESCE( \
                            #                                                 ( \
                            #                                                     SELECT SUM(scheduledquantity) \
                            #                                                     FROM assembly.as_production_schedule \
                            #                                                     WHERE childproduct_id = cp.id AND parentproduct_id = psod.product_id AND so_details_id = psod.id \
                            #                                                 ), \
                            #                                                 0 \
                            #                                             ) AS scheduled_quantity, \
                            #                                             ( \
                            #                                                 CASE \
                            #                                                     WHEN cp.producttype = '227da8713f2341dbbf85f5cb4e3beb43' THEN \
                            #                                                         ( \
                            #                                                             SELECT JSON_AGG( \
                            #                                                                 JSON_BUILD_OBJECT( \
                            #                                                                     'stock_history_id', cpsh.id, \
                            #                                                                     'child_quantity', cps.quantity \
                            #                                                                 ) \
                            #                                                             ) \
                            #                                                             FROM assembly.as_pd_product_structure cps \
                            #                                                             JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                            #                                                             JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                            #                                                             AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                            #                                                             AND cpsh.productionschedule_id IS NULL WHERE cps.parentproduct_id = pps.id \
                            #                                                         ) \
                            #                                                         ELSE \
                            #                                                             ( \
                            #                                                                 SELECT JSON_AGG( \
                            #                                                                     JSON_BUILD_OBJECT( \
                            #                                                                         'stock_history_id', cpsh.id, \
                            #                                                                         'child_quantity', pps.quantity \
                            #                                                                     ) \
                            #                                                                 ) \
                            #                                                                 FROM assembly.as_pd_product_stock ps \
                            #                                                                 JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' AND cpsh.productstock_id = ps.id \
                            #                                                                 AND cpsh.parentproduct_id = psod.product_id AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false \
                            #                                                                 AND cpsh.productionschedule_id IS NULL \
                            #                                                                 WHERE ps.product_id = cp.id \
                            #                                                             ) \
                            #                                                 END \
                            #                                             ) AS stock_history_id_list, \
                            #                                             COALESCE( \
                            #                                                 ( \
                            #                                                     SELECT SUM(scheduledquantity) \
                            #                                                     FROM assembly.as_production_schedule aspsch \
                            #                                                     WHERE aspsch.childproduct_id = pps.childproduct_id AND parentproduct_id = psod.product_id \
                            #                                                     AND so_details_id = psod.id \
                            #                                                 ), \
                            #                                                 0 \
                            #                                             ), \
                            #                                             TRIM(pp.code) AS parent_product, \
                            #                                             TRIM(pp.revisionno) AS parent_revision_number, \
                            #                                             TRIM(pps.id) AS stru_table_id, \
                            #                                             TRIM(cp.id) AS child_product_id, \
                            #                                             TRIM(ppps.childproduct_id) AS parentproduct_id \
                            #                                         FROM assembly.as_pd_product_structure pps \
                            #                                         LEFT JOIN assembly.as_pd_product cp ON cp.id = pps.childproduct_id \
                            #                                         LEFT JOIN assembly.as_pd_product_structure ppps ON ppps.id = pps.parentproduct_id \
                            #                                         LEFT JOIN assembly.as_pd_product pp ON pp.id = ppps.childproduct_id \
                            #                                         LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = pps.childproduct_id \
                            #                                         LEFT JOIN ( \
                            #                                             SELECT id AS parentStockhistory_id , productstock_id, parentproduct_id, sodetails_id, SUM(quantity) AS sum_quantity \
                            #                                             FROM assembly.as_pd_product_stockhistory \
                            #                                             WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                            #                                             GROUP BY id, productstock_id, parentproduct_id, sodetails_id \
                            #                                         ) psh ON psh.productstock_id = ps.id  AND psh.parentproduct_id =  psod.product_id AND psh.sodetails_id =  psod.id \
                            #                                         INNER JOIN product_hierarchy ph ON pps.parentproduct_id = ph.stru_table_id \
                            #                                         WHERE pps.level > ph.level \
                            #                                     ) \
                            #                                     SELECT JSON_AGG( \
                            #                                         JSON_BUILD_OBJECT( \
                            #                                             'child_product', child_product, \
                            #                                             'child_revision_number', child_revision_number, \
                            #                                             'child_product_id', child_product_id, \
                            #                                             'level', level, \
                            #                                             'parent_product', parent_product, \
                            #                                             'parent_revision_number', parent_revision_number, \
                            #                                             'parentproduct_id', parentproduct_id, \
                            #                                             'order_quantity', order_quantity, \
                            #                                             'pending_schedule_quantity', pending_schedule_quantity, \
                            #                                             'scheduled_quantity', scheduled_quantity, \
                            #                                             'stock_history_id_list', stock_history_id_list \
                            #                                         ) \
                            #                                     ) \
                            #                                     FROM product_hierarchy \
                            #                                 ) \
                            #                             ) \
                            #                         ) \
                            #         FROM assembly.as_pd_product_salesorderdetails psod \
                            #         LEFT JOIN assembly.as_pd_product op ON op.id = psod.product_id \
                            #         WHERE psod.so_id = pso.id \
                            #     ) AS sales_order_details, \
                            #     pso.id AS sales_order_id \
                            # FROM assembly.as_pd_product_salesorders pso \
                            # ORDER BY pso.updatedon DESC;

                                # SELECT \
                                # TRIM(pso.referencedocumentnumber) AS sales_order_number, \
                                # ( \
                                #     SELECT JSON_AGG( \
                                #         JSON_BUILD_OBJECT( \
                                #             'product', TRIM(op.code), \
                                #             'revision', TRIM(op.revisionno), \
                                #             'linenumber', psod.linenumber, \
                                #             'quantity', psod.quantity, \
                                #             'dispatchdate', psod.dispatchdate, \
                                #             'so_id', psod.so_id, \
                                #             'so_details_id', psod.id, \
                                #             'product_id', psod.product_id, \
                                #             'product_structure', ( \
                                #                 WITH RECURSIVE product_hierarchy AS ( \
                                #                     SELECT DISTINCT ON (TRIM(pps.id)) \
                                #                         TRIM(cp.code) AS child_product, \
                                #                         TRIM(cp.revisionno) AS child_revision_number, \
                                #                         pps.level, \
                                #                         GREATEST(((COALESCE(psod.quantity,0) * COALESCE(pps.quantity,0)) - COALESCE(psh.sum_quantity,0)),0) AS order_quantity, \
                                #                         COALESCE(( \
                                #                             SELECT \
                                #                                 MIN(GREATEST( \
                                #                                     COALESCE(child_sum_quantity,0) / NULLIF(COALESCE(cps.quantity,0),0), \
                                #                                     0 \
                                #                                 )) \
                                #                             FROM assembly.as_pd_product_structure cps \
                                #                             LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                #                             LEFT JOIN ( \
                                #                                 SELECT \
                                #                                     productstock_id, \
                                #                                     parentproduct_id, \
                                #                                     sodetails_id, \
                                #                                     SUM(quantity) AS child_sum_quantity \
                                #                                 FROM assembly.as_pd_product_stockhistory \
                                #                                 WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                                #                                 GROUP BY productstock_id, parentproduct_id, sodetails_id \
                                #                             ) cpsh ON cpsh.productstock_id = ps.id \
                                #                                 AND cpsh.parentproduct_id = psod.product_id \
                                #                                 AND cpsh.sodetails_id = psod.id \
                                #                             WHERE cps.parentproduct_id = pps.id \
                                #                         ),0)AS pending_schedule_quantity, \
                                #                         COALESCE(( \
                                #                             SELECT SUM(scheduledquantity) \
                                #                             FROM assembly.as_production_schedule \
                                #                             WHERE childproduct_id = cp.id \
                                #                             AND parentproduct_id = psod.product_id \
                                #                             AND so_details_id = psod.id \
                                #                         ),0) AS scheduled_quantity, \
                                #                         ( \
                                #                             SELECT JSON_AGG( \
                                #                                 JSON_BUILD_OBJECT( \
                                #                                     'stock_history_id', cpsh.id, \
                                #                                     'child_quantity', cps.quantity \
                                #                                 ) \
                                #                             ) \
                                #                             FROM assembly.as_pd_product_structure cps \
                                #                             JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                #                             JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' \
                                #                                 AND cpsh.productstock_id = ps.id AND cpsh.parentproduct_id = psod.product_id \
                                #                                 AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false AND cpsh.productionschedule_id IS NULL \
                                #                             WHERE cps.parentproduct_id = pps.id \
                                #                         ) AS stock_history_id_list, \
                                #                         COALESCE( \
                                #                             ( \
                                #                                 SELECT SUM(scheduledquantity) \
                                #                                 FROM assembly.as_production_schedule aspsch \
                                #                                 WHERE aspsch.childproduct_id = pps.childproduct_id \
                                #                                 AND parentproduct_id = psod.product_id \
                                #                                 AND so_details_id = psod.id \
                                #                             ), \
                                #                             0 \
                                #                         ), \
                                #                         TRIM(pp.code) AS parent_product, \
                                #                         TRIM(pp.revisionno) AS parent_revision_number, \
                                #                         TRIM(pps.id) AS stru_table_id, \
                                #                         TRIM(cp.id) AS child_product_id, \
                                #                         TRIM(ppps.childproduct_id) AS parentproduct_id \
                                #                     FROM assembly.as_pd_product_structure pps \
                                #                     LEFT JOIN assembly.as_pd_product cp ON cp.id = pps.childproduct_id \
                                #                     LEFT JOIN assembly.as_pd_product_structure ppps ON ppps.id = pps.parentproduct_id \
                                #                     LEFT JOIN assembly.as_pd_product pp ON pp.id = ppps.childproduct_id \
                                #                     LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = pps.childproduct_id \
                                #                     LEFT JOIN ( \
                                #                         SELECT \
                                #                             productstock_id, \
                                #                             parentproduct_id, \
                                #                             sodetails_id, \
                                #                             SUM(quantity) AS sum_quantity \
                                #                         FROM assembly.as_pd_product_stockhistory \
                                #                         WHERE stockevent = 'Issue' \
                                #                         GROUP BY productstock_id, parentproduct_id, sodetails_id \
                                #                     ) psh ON psh.productstock_id = ps.id  AND psh.parentproduct_id =  psod.product_id AND psh.sodetails_id =  psod.id \
                                #                     WHERE pps.childproduct_id = psod.product_id \
                                #                         AND pps.revisionno = op.revisionno \
                                #                         AND pps.level = 0 \
                                #                     UNION ALL \
                                #                     SELECT DISTINCT ON (TRIM(pps.id)) \
                                #                         TRIM(cp.code) AS child_product, \
                                #                         TRIM(cp.revisionno) AS child_revision_number, \
                                #                         pps.level, \
                                #                         GREATEST(((COALESCE(pps.quantity, 0) * COALESCE(ph.order_quantity, 0)) - COALESCE(psh.sum_quantity,0)), 0) AS order_quantity, \
                                #                         COALESCE(( \
                                #                             SELECT \
                                #                                 MIN(GREATEST( \
                                #                                     COALESCE(child_sum_quantity,0) / NULLIF(COALESCE(cps.quantity,0),0), \
                                #                                     0 \
                                #                                 )) \
                                #                             FROM assembly.as_pd_product_structure cps \
                                #                             LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                #                             LEFT JOIN ( \
                                #                                 SELECT \
                                #                                     productstock_id, \
                                #                                     parentproduct_id, \
                                #                                     sodetails_id, \
                                #                                     SUM(quantity) AS child_sum_quantity \
                                #                                 FROM assembly.as_pd_product_stockhistory \
                                #                                 WHERE stockevent = 'Issue' AND productionschedule_id IS NULL \
                                #                                 GROUP BY productstock_id, parentproduct_id, sodetails_id \
                                #                             ) cpsh ON cpsh.productstock_id = ps.id  AND cpsh.parentproduct_id =  psod.product_id AND cpsh.sodetails_id =  psod.id \
                                #                             WHERE cps.parentproduct_id = pps.id \
                                #                         ),0) AS pending_schedule_quantity, \
                                #                         COALESCE(( \
                                #                             SELECT SUM(scheduledquantity) \
                                #                             FROM assembly.as_production_schedule \
                                #                             WHERE childproduct_id = cp.id \
                                #                             AND parentproduct_id = psod.product_id \
                                #                             AND so_details_id = psod.id \
                                #                         ),0) AS scheduled_quantity, \
                                #                         ( \
                                #                             SELECT JSON_AGG( \
                                #                                 JSON_BUILD_OBJECT( \
                                #                                     'stock_history_id', cpsh.id, \
                                #                                     'child_quantity', cps.quantity \
                                #                                 ) \
                                #                             ) \
                                #                             FROM assembly.as_pd_product_structure cps \
                                #                             JOIN assembly.as_pd_product_stock ps ON ps.product_id = cps.childproduct_id \
                                #                             JOIN assembly.as_pd_product_stockhistory cpsh ON stockevent = 'Issue' \
                                #                                 AND cpsh.productstock_id = ps.id AND cpsh.parentproduct_id = psod.product_id \
                                #                                 AND cpsh.sodetails_id = psod.id  AND cpsh.deleted = false AND cpsh.productionschedule_id IS NULL \
                                #                             WHERE cps.parentproduct_id = pps.id \
                                #                         ) AS stock_history_id_list, \
                                #                         COALESCE( \
                                #                             ( \
                                #                                 SELECT SUM(scheduledquantity) \
                                #                                 FROM assembly.as_production_schedule aspsch \
                                #                                 WHERE aspsch.childproduct_id = pps.childproduct_id \
                                #                                 AND parentproduct_id = psod.product_id \
                                #                                 AND so_details_id = psod.id \
                                #                             ), \
                                #                             0 \
                                #                         ), \
                                #                         TRIM(pp.code) AS parent_product, \
                                #                         TRIM(pp.revisionno) AS parent_revision_number, \
                                #                         TRIM(pps.id) AS stru_table_id, \
                                #                         TRIM(cp.id) AS child_product_id, \
                                #                         TRIM(ppps.childproduct_id) AS parentproduct_id \
                                #                     FROM assembly.as_pd_product_structure pps \
                                #                     LEFT JOIN assembly.as_pd_product cp ON cp.id = pps.childproduct_id \
                                #                     LEFT JOIN assembly.as_pd_product_structure ppps ON ppps.id = pps.parentproduct_id \
                                #                     LEFT JOIN assembly.as_pd_product pp ON pp.id = ppps.childproduct_id \
                                #                     LEFT JOIN assembly.as_pd_product_stock ps ON ps.product_id = pps.childproduct_id \
                                #                     LEFT JOIN ( \
                                #                         SELECT \
                                #                             productstock_id, \
                                #                             parentproduct_id, \
                                #                             sodetails_id, \
                                #                             SUM(quantity) AS sum_quantity \
                                #                         FROM assembly.as_pd_product_stockhistory \
                                #                         WHERE stockevent = 'Issue' \
                                #                         GROUP BY productstock_id, parentproduct_id, sodetails_id \
                                #                     ) psh ON psh.productstock_id = ps.id  AND psh.parentproduct_id =  psod.product_id AND psh.sodetails_id =  psod.id \
                                #                     INNER JOIN product_hierarchy ph ON pps.parentproduct_id = ph.stru_table_id \
                                #                     WHERE pps.level > ph.level \
                                #                 ) \
                                #                 SELECT JSON_AGG( \
                                #                     JSON_BUILD_OBJECT( \
                                #                         'child_product', child_product, \
                                #                         'child_revision_number', child_revision_number, \
                                #                         'child_product_id', child_product_id, \
                                #                         'level', level, \
                                #                         'parent_product', parent_product, \
                                #                         'parent_revision_number', parent_revision_number, \
                                #                         'parentproduct_id', parentproduct_id, \
                                #                         'order_quantity', order_quantity, \
                                #                         'pending_schedule_quantity', pending_schedule_quantity, \
                                #                         'scheduled_quantity', scheduled_quantity, \
                                #                         'stock_history_id_list', stock_history_id_list \
                                #                     ) \
                                #                 ) FROM product_hierarchy \
                                #             ) \
                                #         ) \
                                #     ) \
                                #     FROM assembly.as_pd_product_salesorderdetails psod \
                                #     LEFT JOIN assembly.as_pd_product op ON op.id = psod.product_id \
                                #     WHERE psod.so_id = pso.id \
                                # ) AS sales_order_details, \
                                # pso.id AS sales_order_id \
                                # FROM assembly.as_pd_product_salesorders pso \
                                # ORDER BY pso.updatedon DESC;
